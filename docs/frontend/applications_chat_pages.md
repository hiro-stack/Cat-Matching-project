# 応募・チャットページ仕様書

## 1. ページ概要

里親と保護団体がコミュニケーションを取るための主要機能です。
**応募一覧ページ**でステータスを確認し、**詳細・チャットページ**でメッセージ交換や審査を行います。

---

## 2. 画面レイアウト・コンテンツ配置

### 2.1 応募一覧ページ (`/applications`)

- **リスト表示**:
  - 自身の関わる応募（里親なら自分の応募、団体なら自猫への応募）を一覧表示。
  - Infinite Scroll 対応。
- **カードコンテンツ**:
  - **左**: 猫のサムネイル画像、猫の名前、相手の名前（団体名 or 応募者名）。
  - **右**: ステータスバッジ（審査中、承認済など）。
  - クリックでチャット画面へ遷移。

### 2.2 詳細・チャットページ (`/applications/[id]`)

画面の高さをいっぱい (`100vh`) に使い、チャットアプリのようなUIを提供。

#### ヘッダーエリア

- **タイトル**: 応募対象の猫の名前を表示。
- **ステータス操作 (保護団体のみ)**:
  - 審査中 (`pending`) の場合、「承認する」「見送る」ボタンを表示。
  - 現在のステータスバッジを表示。

#### メッセージエリア (中央・スクロール)

- **チャットログ**:
  - 自分と相手のメッセージを左右に分けて吹き出し表示。
  - 自分の発言: 右寄せ、メインカラー背景。
  - 相手の発言: 左寄せ、白背景。
  - **表示順序**: APIは `created_at` 昇順で取得。UI上では上から下へ時系列順に表示。
- **ページング制御**:
  - 上部に「**過去のメッセージを読み込む**」ボタンを配置。
  - クリックすると `page=n+1` (より古いデータ) を取得し、リストの上部に追加ロードする。

#### 入力エリア (最下部固定)

- **メッセージ入力**:
  - 複数行対応の `TextArea`。
  - `Ctrl + Enter` での送信ショートカットに対応。
- **送信ボタン**:
  - ローディング中はDisable化。

---

## 3. 実装詳細

### ファイル

- `frontend/src/app/applications/page.tsx`
- `frontend/src/app/applications/[id]/page.tsx`

### 技術的実装

1.  **リアルタイム性 (SWR Polling & Optimistic UI)**:
    - チャットメッセージ取得に `refreshInterval: 5000` を設定し、5秒ごとに自動更新（ポーリング）を行う。
    - **新着メッセージ**: リストの末尾（最下部）に追加される。
    - 送信時はSWRの `mutate` を利用して即座に画面反映を行ってもよい（Optimistic UI）。

2.  **SWR Infiniteの実践**:
    - メッセージログは時系列順（API仕様準拠）で取得。
    - `useSWRInfinite` でページング処理を行い、過去/未来のログ取得に対応（現状は昇順取得）。

3.  **スクロール制御**:
    - メッセージ送信後や初回ロード時に `scrollIntoView` を使用し、自動的にチャット最下部（最新）へスクロールするUXを実装。

4.  **ステータス変更**:
    - 保護団体ユーザーの場合、`applicationsService.updateStatus` を呼び出して応募のステータスを更新。
    - 更新後、即座に画面上のバッジとボタン表示を切り替える (`mutate`)。
